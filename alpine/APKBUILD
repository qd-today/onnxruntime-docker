# Maintainer: leso-kn <info@lesosoftware.com>
pkgname=onnxruntime
pkgver=1.20.1
pkgrel=0
pkgdesc="Cross-platform, high performance ML inferencing and training accelerator"
url="https://onnxruntime.ai"
# x86, s390x, loongarch64: fails to build
# riscv64: tests fails
arch="all !x86 !s390x !riscv64 !loongarch64"
license="MIT"
makedepends="
	abseil-cpp-dev
	bash
	cmake
	eigen-dev
	gnu-libiconv-dev
	gtest-dev
	icu-dev
	linux-headers
	nlohmann-json
	protobuf-dev
	py3-numpy
	py3-numpy-dev
	py3-pip
	py3-protobuf
	py3-pybind11-dev
	py3-setuptools
	py3-wheel
	python3-dev
	re2-dev
	samurai
	zlib-dev
	"
subpackages="
	$pkgname-dev
	py3-$pkgname-pyc
	py3-$pkgname:py3
	libonnxruntime:lib
	"
source="$pkgname-$pkgver.tar.gz::https://github.com/microsoft/onnxruntime/archive/refs/tags/v$pkgver.tar.gz
	flatbuffers-locale.patch.noauto
	no-execinfo.patch
	0001-Remove-MATH_NO_EXCEPT-macro.patch
	system.patch
	"
options="net"

# tests fail on arm 32 bit, see https://github.com/microsoft/onnxruntime/issues/16387
case "$CARCH" in
armhf|armv7) options="!check $options"; _extra_cxxflags="-Wno-overflow -flto=auto";  _extra_cflags="-flto=auto";;
ppc64le) _extra_cxxflags="-fno-lto"; _extra_cflags="-fno-lto";;
*) _extra_cxxflags="-flto=auto"; _extra_cflags="-flto=auto";;
esac

build() {
	CFLAGS="$CFLAGS -O2 $_extra_cflags " \
	CXXFLAGS="$CXXFLAGS $_extra_cxxflags -O2 -Wno-deprecated-declarations -Wno-error=template-id-cdtor -U_FORTIFY_SOURCE -Wno-unused-variable -Wno-unused-parameter" \
	LDFLAGS="$LDFLAGS -Wl,--copy-dt-needed-entries" \
	cmake -S cmake -B build -G Ninja -Wno-dev \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DBUILD_ONNX_PYTHON=ON \
		-Donnxruntime_BUILD_SHARED_LIB=ON \
		-Donnxruntime_BUILD_UNIT_TESTS="$(want_check && echo ON || echo OFF)" \
		-Donnxruntime_ENABLE_PYTHON=ON \
		-Donnxruntime_USE_NEURAL_SPEED=OFF # fix for 1.17.0, see: https://github.com/microsoft/onnxruntime/pull/19382
	# hack for protobuf 23
	sed -i 's|CMAKE_CXX_STANDARD 11|CMAKE_CXX_STANDARD 17|' build/_deps/onnx-src/CMakeLists.txt

	# from testing/flutter/shared-libcxx.patch.engine
	patch -p1 < ../flatbuffers-locale.patch.noauto

	cmake --build build

	cd build
	msg "building python module"
	python3 ../setup.py build
}

check() {
	ctest --test-dir build --output-on-failure
}

package() {
	DESTDIR="$pkgdir" cmake --install build

	cd build
	python3 ../setup.py install --skip-build --root="$pkgdir"

	ln -sfv ../../../../libonnxruntime_providers_shared.so \
		"$(echo "$pkgdir"/usr/lib/python3*/site-packages/onnxruntime/capi/libonnxruntime_providers_shared.so)"
}

py3() {
	pkgdesc="$pkgname (python3 bindings)"
	depends="
		py3-coloredlogs
		py3-flatbuffers
		py3-numpy
		py3-packaging
		py3-sympy
		"

	amove usr/lib/python3*
}

lib() {
	pkgdesc="$pkgdesc ($subpkgname library)"

	amove usr/lib/$subpkgname.so.*
}

sha512sums="
f9e8e350567ca6bf6bc9dc08886936338469256ce0e92147f883fbb76c9f2213d46f8915c89254c00b9b9f7b1ab20517687af33c0fa20110154f2d47da5ca759  onnxruntime-1.20.1.tar.gz
52e1c1e4a69543b3b9bcfabbd3f6202edf309f56be129668ad226e7ad7c2f1220ce169f9957fbc1fc4f3cae5abc984f8fe5ea4990fb2ebb033d7111d1d298f95  flatbuffers-locale.patch.noauto
976913be90b0a82ff1ba403f46306ef4e5939bb05296227c99d3c4a609dd00f5750f9b1c6c30d20791ff0724c1bcffc6aa498eac906257aefefc6f35df796fe0  no-execinfo.patch
b70a09b0de7921e494a85fe7f0ac46ad9c1117e9dcf8f7ec45e518df975bb56e1b663396ae969deaaabda94135c5b6e082f59d8b916483518589ffde14c04565  0001-Remove-MATH_NO_EXCEPT-macro.patch
7799f6980b5d9cb65bfc3cb9fe940552cf92674c243fef05368aa60862191cb013c9ddbb364fb7e775542a8418f5b50e175ede3e37b69f8e70446455a4954482  system.patch
"
